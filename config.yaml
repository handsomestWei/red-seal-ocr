# OCR识别系统配置文件

# ============================================================================
# 图像预处理配置
# ============================================================================
preprocessing:
  # 是否启用图像预处理（提取红色区域）
  # 启用后可以更好地识别红色印章文字，减少背景干扰
  enabled: true

# ============================================================================
# 红色区域提取配置
# ============================================================================
red_extraction:
  # HSV颜色空间红色范围1（色相环0-20度，偏橙红色）
  # H: 色相 (0-180)，S: 饱和度 (0-255)，V: 明度 (0-255)
  hsv_lower: [0, 20, 20]    # 红色下限：H=0-20, S>=20, V>=20
  hsv_upper: [20, 255, 255] # 红色上限：H<=20, S<=255, V<=255
  
  # HSV颜色空间红色范围2（色相环160-180度，偏紫红色）
  hsv_lower2: [160, 20, 20]  # 红色下限：H=160-180, S>=20, V>=20
  hsv_upper2: [180, 255, 255] # 红色上限：H<=180, S<=255, V<=255
  
  # 说明：红色在色相环的两端（0-20和160-180），扩大范围可以识别更多红色印章
  # 包括偏橙或偏粉的红色。S和V的下限设为20可以识别较浅的红色印章

# ============================================================================
# 红色区域增强配置
# ============================================================================
red_enhancement:
  # 是否启用红色增强
  enabled: true
  
  # 红色饱和度增强系数（>1.0表示增强）
  # 值越大，红色越鲜艳。建议范围：1.3-2.0
  # 对于浅红色印章，可以适当增大（如1.6-1.8）
  red_saturation_boost: 2.3
  
  # 红色亮度增强系数（>1.0表示增强）
  # 值越大，红色越亮。建议范围：1.1-1.5
  # 对于浅红色印章，可以适当增大（如1.2-1.4）
  red_brightness_boost: 1.55
  
  # 亮度伽马调整（<1.0提亮，>1.0变暗）
  # 0.9表示轻微提亮，使浅红色更明显。建议范围：0.85-0.95
  value_gamma: 0.82
  
  # CLAHE（对比度受限的自适应直方图均衡化）参数
  # clip_limit: 对比度限制，值越大对比度增强越强。建议范围：2.0-4.0
  # 对于浅红色印章，可以适当增大（如3.0-4.0）
  clahe_clip_limit: 5.0
  
  # CLAHE的网格大小 [宽度, 高度]
  # 值越小，增强越局部化，适合小文字。建议范围：[6,6] 到 [8,8]
  clahe_tile_grid: [3, 3]
  
  # 是否去除黑色文字和线条
  remove_black: true
  
  # 黑色判断阈值（亮度低于此值认为是黑色，范围0-255）
  # 值越小，去除的黑色越多。建议范围：50-70
  # 对于浅红色印章，可以适当降低（如50-60）以去除更多干扰
  black_threshold: 48
  
  # 黑色判断时允许的饱和度上限（范围0-255）
  # 如果像素的饱和度高于此值，即使亮度很低也不认为是黑色（可能是暗红色）
  # 这样可以保护暗红色文字不被误删。建议范围：70-100
  black_saturation_threshold: 90
  
  # 是否保护暗红色文字（避免被误删为黑色）
  preserve_dark_red: true
  
  # 是否去除灰色表格线
  remove_gray: true
  
  # 灰色判断阈值（饱和度低于此值认为是灰色，范围0-1）
  # 值越小，去除的灰色越多。建议范围：0.2-0.4
  gray_threshold: 0.3
  
  # 说明：红色区域增强配置用于提升浅红色印章的可见性
  # 通过增强饱和度/亮度、应用局部对比(CLAHE)和伽马调整来加深浅色印章
  # 同时在保留暗红文字的前提下去除黑色或灰色干扰

# ============================================================================
# 形态学操作配置
# ============================================================================
morphology:
  # 形态学操作核大小（像素）
  # 值越小，对文字的影响越小。建议范围：2-5
  kernel_size: 3
  
  # 形态学操作迭代次数
  # 值越小，对文字的影响越小。建议范围：1-3
  iterations: 2
  
  # 说明：形态学操作用于去除噪声，但过度操作会破坏文字结构
  # 已优化为最小化处理，保持文字完整性

# ============================================================================
# 图片压缩优化配置
# ============================================================================
image_optimization:
  # 是否启用图片压缩优化
  enabled: true
  
  # 图片最大尺寸（像素），超过此尺寸会自动缩放
  # 值越大，图片质量越好但处理越慢。建议范围：1200-1500
  # 注意：此值应 <= text_det_limit_side_len（OCR性能配置中的检测边长限制）
  # 如果超过 text_det_limit_side_len，PaddleOCR 内部会再次缩放，可能导致异常
  # 当前 text_det_limit_side_len=1280，因此 max_size 应 <= 1280
  max_size: 1280
  
  # JPEG压缩质量（0-100，值越大质量越好）
  # 建议范围：85-95，平衡质量和文件大小
  jpeg_quality: 90
  
  # 说明：图片压缩优化用于提高OCR处理速度
  # 在保证识别准确率的前提下，适当压缩可以显著提升处理速度
  # max_size建议1500-2000，jpeg_quality建议85-95

# ============================================================================
# OCR性能优化配置
# ============================================================================
ocr_performance:
  # 是否使用快速模型（mobile模型，速度更快但精度略低）
  use_fast_model: true
  
  # 文本检测阈值（范围0-1，值越小检测越敏感）
  # 建议范围：0.3-0.5
  det_db_thresh: 0.3
  
  # 文本检测框阈值（范围0-1，值越小保留的框越多）
  # 建议范围：0.5-0.7
  det_db_box_thresh: 0.5
  
  # 文本检测框扩展比例（>1.0表示扩展）
  # 值越大，检测框越大。建议范围：1.5-2.0
  det_db_unclip_ratio: 1.6
  
  # 文本识别批处理数量（同时处理的文本数量）
  # 值越大，速度越快但内存占用越多。建议范围：6-12
  # 注意：新版本参数名为text_recognition_batch_size，rec_batch_num已弃用
  text_recognition_batch_size: 8
  rec_batch_num: 8  # 兼容旧配置名
  
  # 文本检测输入边长限制（像素）
  # 限制输入图片的最大边长，超过此值会自动缩放，可以大幅提升检测速度
  # 建议范围：960-1280，值越小速度越快但可能影响小文字检测
  # 如果为null或不设置，则不限制（使用原图大小）
  text_det_limit_side_len: 1280
  
  # 是否使用文本行方向分类（旧名称：use_angle_cls）
  # true: 自动检测并纠正文本行方向（0°、90°、180°、270°），适合拍照图片可能不正的情况
  # false: 关闭方向分类，速度更快但无法处理倾斜或倒置的文字
  # 建议：
  #   - 如果图片可能侧着、倒置或倾斜，建议设为true（推荐）
  #   - 如果图片都是正向的，可以设为false以提升速度
  #   - 对于红色印章文字，如果预处理（红色区域提取）做得好，通常提取出的区域是正向的
  #     但如果原图本身不正，建议开启此功能
  use_textline_orientation: true
  
  # OCR模型版本（可选：PP-OCRv3, PP-OCRv4, PP-OCRv5）
  # 如果不指定，会根据语言自动选择（中文默认PP-OCRv5）
  # PP-OCRv5: 最新版本，精度最高但速度较慢
  # PP-OCRv4: 平衡版本，速度和精度平衡
  # PP-OCRv3: 旧版本，速度较快但精度较低
  # 注意：如果指定了 text_detection_model_name，此参数可能被覆盖
  # 建议：追求速度可设为PP-OCRv4，追求精度可设为PP-OCRv5或不设置（默认）
  ocr_version: PP-OCRv5  # 例如: "PP-OCRv5" 或 "PP-OCRv4"
  
  # 文本检测模型名称（可选，用于指定具体的检测模型）
  # 常用模型：
  #   - PP-OCRv5_mobile_det: 移动端模型，速度最快，精度略低
  #   - PP-OCRv5_server_det: 服务端模型，精度最高，速度较慢
  #   - PP-OCRv4_mobile_det: v4移动端模型
  #   - PP-OCRv4_server_det: v4服务端模型
  # 如果指定了此参数，将使用指定的检测模型，而不是 ocr_version 自动选择的模型
  # 如果为null或不设置，将根据 ocr_version 自动选择模型
  text_detection_model_name: PP-OCRv5_mobile_det  # 例如: "PP-OCRv5_mobile_det" 或 null
  
  # 文本检测模型目录（可选，用于使用本地模型）
  # 如果指定了本地模型路径，将使用本地模型而不是自动下载
  # 模型目录应包含 inference.pdiparams 和 inference.yml 等文件
  # 如果为null或不设置，将自动下载模型
  text_detection_model_dir: null  # 例如: "./models/PP-OCRv5_mobile_det" 或 null
  
  # 文本识别模型名称（可选，用于指定具体的识别模型）
  # 常用模型：
  #   - PP-OCRv5_mobile_rec: 移动端模型，速度最快，精度略低
  #   - PP-OCRv5_server_rec: 服务端模型，精度最高，速度较慢
  #   - PP-OCRv4_mobile_rec: v4移动端模型
  #   - PP-OCRv4_server_rec: v4服务端模型
  # 如果指定了此参数，将使用指定的识别模型，而不是 ocr_version 自动选择的模型
  # 如果为null或不设置，将根据 ocr_version 自动选择模型
  text_recognition_model_name: PP-OCRv5_mobile_rec  # 例如: "PP-OCRv5_mobile_rec" 或 null
  
  # 文本识别模型目录（可选，用于使用本地模型）
  # 如果指定了本地模型路径，将使用本地模型而不是自动下载
  # 模型目录应包含 inference.pdiparams 和 inference.yml 等文件
  # 如果为null或不设置，将自动下载模型
  text_recognition_model_dir: null  # 例如: "./models/PP-OCRv5_mobile_rec" 或 null
  
  # CPU线程数（用于CPU推理）
  # 默认值：8（PaddleOCR默认值）
  # 建议值：根据CPU核心数设置，通常设置为CPU核心数或略少
  # 例如：4核CPU可设置为4，8核CPU可设置为8
  # 注意：增加线程数可能提高速度，但也会增加CPU占用和功耗
  # 如果为null或不设置，使用PaddleOCR默认值（8）
  cpu_threads: null  # 例如: 4 或 8
  
  # 计算精度（用于模型推理）
  # 可选值：fp32（32位浮点，默认，精度最高）、fp16（16位浮点，速度更快，内存占用更少）
  # 默认值：fp32（PaddleOCR默认值）
  # fp16优势：
  #   - 推理速度提升约20-30%
  #   - 内存占用减少约50%
  #   - 精度损失通常很小（<1%）
  # 注意：需要硬件支持（现代GPU和部分CPU支持），如果不支持会自动回退到fp32
  # 建议：如果追求速度且硬件支持，可以设置为fp16
  precision: "fp32"  # 可选: "fp16"（速度更快，内存占用更少）
  
  # 说明：OCR性能优化参数用于调整检测和识别阈值
  # text_det_limit_side_len是重要的性能参数，限制输入边长可以大幅提升速度
  # use_textline_orientation设为false可以关闭方向分类，提升速度
  # text_recognition_batch_size增大可以提升识别速度，但会增加内存占用
  # ocr_version可以指定模型版本，PP-OCRv4速度较快，PP-OCRv5精度较高
  # cpu_threads和precision可以进一步提升CPU推理速度

# ============================================================================
# 图片增强配置（用于低质量图片）
# ============================================================================
image_enhancement:
  # 是否启用图片增强
  enabled: true
  
  # 文件大小阈值（KB），小于此值认为是低质量图片
  # 建议范围：150-300
  size_threshold_kb: 200
  
  # 分辨率阈值（像素），小于此值认为是低质量图片
  # 建议范围：1000-1500
  resolution_threshold: 1200
  
  # 低质量图片是否跳过红色区域提取
  # false（推荐）：先增强 → 红色区域提取 → OCR
  # true：增强 → 直接OCR（跳过红色区域提取）
  skip_preprocessing_for_low_quality: false
  
  # 去噪强度（0-10，值越大去噪越强）
  # 建议范围：2-5，过度去噪会丢失细节
  denoise_strength: 3
  
  # 锐化强度（0-1，值越大锐化越强）
  # 建议范围：0.3-0.7，过度锐化会产生伪影
  sharpen_strength: 0.5
  
  # 对比度增强系数（1.0表示不变，>1.0增强）
  # 建议范围：1.0-1.2，过度增强会失真
  contrast_alpha: 1.1
  
  # 亮度调整（-50到+50，0表示不变）
  # 建议范围：-10到+10
  brightness_beta: 0
  
  # 说明：图片增强配置用于提升小质量图片的识别效果
  # 对文件小于size_threshold_kb或分辨率小于resolution_threshold的图片进行增强处理
  # skip_preprocessing_for_low_quality为false时（推荐），小质量图片先增强，
  # 然后对增强后的图片进行红色区域提取，最后OCR
  # 为true时，跳过红色区域提取，直接使用增强后的原图进行OCR

# ============================================================================
# HTTP服务器配置
# ============================================================================
server:
  # 服务器监听地址
  # 0.0.0.0 表示监听所有网络接口，127.0.0.1 表示仅本地访问
  host: "0.0.0.0"
  
  # 服务器监听端口
  port: 5000
  
  # 是否启用调试模式
  # true: 启用Flask调试模式（代码修改自动重载，显示详细错误信息）
  # false: 生产模式
  debug: false
  
  # 图片下载超时配置（秒）
  # connect_timeout: 连接服务器超时时间，建议5-15秒
  # read_timeout: 读取数据超时时间，对于大图片或网络较慢的情况可以适当增加
  download_timeout:
    connect_timeout: 5  # 连接超时
    read_timeout: 10     # 读取超时
  
  # 是否验证SSL证书
  # true: 验证SSL证书（推荐，更安全）
  # false: 跳过SSL验证（适用于自签名证书或证书有问题的服务器）
  verify_ssl: true
  
  # OCR实例池配置
  ocr_pool:
    # OCR实例池大小（同时可用的OCR实例数量）
    # 建议根据服务器CPU和内存资源设置，一般设置为CPU核心数或略少
    pool_size: 2
  
  # 批量OCR接口配置
  batch_ocr:
    # 单次请求最大图片数量
    max_images: 10
    
    # 图片下载线程池大小（并行下载的线程数）
    download_threads: 10

# ============================================================================
# 日志配置
# ============================================================================
logging:
  # 日志文件路径（相对于项目根目录）
  log_file: "logs/api_server.log"
  
  # 日志级别: DEBUG, INFO, WARNING, ERROR, CRITICAL
  level: "DEBUG"
  
  # 是否同时输出到控制台
  console_output: true
  
  # 单个日志文件最大大小（MB）
  max_file_size_mb: 100
  
  # 保留的日志文件数量（超过此数量会自动删除最旧的）
  retention_count: 10
  
  # 是否压缩旧日志文件
  compression: true
  
  # 日志格式（包含线程号，方便追踪HTTP请求）
  format: "{time:YYYY-MM-DD HH:mm:ss.SSS} | {level: <8} | [线程:{thread.id}] | {name}:{function}:{line} - {message}"
  
  # 说明：日志文件会自动轮转，当单个文件超过max_file_size_mb时会创建新文件
  # 旧文件会被压缩（如果compression为true），最多保留retention_count个文件

