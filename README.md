# red-seal-ocr

使用图像红色区域预处理 + PaddleOCR识别图片中的红色印章文字。

## 功能特点

- 自动识别印章中的文字
- 支持批量处理多张图片
- **图像预处理**：提取红色区域，提高印章识别准确率。官方模型对于方块等小印章红色文字识别效果较差，因此增加预处理流程，剔除无关文字的噪声影响。
- 支持低质量图片自动增强
- 支持HTTP API服务模式
- 支持多OCR实例运行实现多线程并发处理

## 安装步骤

1. 安装依赖包：
```bash
pip install -r requirements.txt
```

2. 首次运行时会自动下载PaddleOCR模型文件（约几百MB），请确保网络连接正常。

## 使用方法

### 命令行模式

1. 将需要识别的图片放入 `img/` 目录

2. 运行主程序：
```bash
python main.py
```

3. 程序会自动处理 `img/` 目录下的所有图片，识别结果会保存到 `ocr_results.txt` 文件中。

### HTTP API服务模式

启动HTTP服务：
```bash
python api_server.py
```

服务启动后，可以通过HTTP接口进行OCR识别：
- 健康检查：`GET /health`
- 单图识别：`POST /ocr`
- 批量识别：`POST /ocr/batch`

详细API文档请参考代码中的接口定义。

## 服务化多实例运行

系统采用**OCR实例池**机制实现多实例并发处理，提高服务吞吐量和稳定性。

### 工作原理

1. **实例池初始化**：
   - 服务启动时，根据配置的 `pool_size` 创建多个OCR引擎实例
   - 每个实例独立加载PaddleOCR模型，互不干扰
   - 实例存储在线程安全的队列中，支持并发访问

2. **请求处理流程**：
   ```
   HTTP请求到达
       ↓
   从实例池获取OCR实例（如果无可用实例则返回503）
       ↓
   使用OCR实例进行识别
       ↓
   识别完成后归还实例到池中
   ```

3. **资源管理**：
   - 使用上下文管理器（`with`语句）确保实例正确释放
   - 支持超时机制，避免长时间等待
   - 实例异常时自动重新初始化，不影响其他实例

### 配置方法

在 `config.yaml` 中配置实例池大小：

```yaml
server:
  ocr_pool:
    # OCR实例池大小（同时可用的OCR实例数量）
    # 建议根据服务器CPU和内存资源设置，一般设置为CPU核心数或略少
    pool_size: 2
```

**配置建议**：
- **CPU核心数**：建议设置为CPU核心数或略少（如4核CPU设置为2-4）
- **内存限制**：每个OCR实例约占用1-2GB内存，需确保总内存充足
- **并发需求**：根据实际并发请求量调整，一般2-4个实例即可满足大部分场景

### 性能优势

- **并发处理**：多个请求可以同时使用不同的OCR实例，提高吞吐量
- **资源隔离**：每个实例独立运行，单个实例异常不影响其他实例
- **稳定性提升**：实例异常时自动重新初始化，服务持续可用

### 注意事项

1. **内存占用**：
   - 每个OCR实例会占用约1-2GB内存
   - 总内存需求 = pool_size × 单实例内存 + 系统内存
   - 建议服务器内存 ≥ (pool_size + 1) × 2GB

2. **CPU使用**：
   - 多个实例会并行使用CPU资源
   - 建议监控CPU使用率，避免过载

3. **异常处理**：
   - 当实例池中无可用实例时，请求会返回503错误
   - 系统会自动重新初始化异常实例，但需要一定时间
   - 建议设置合理的 `pool_size`，避免所有实例同时异常

4. **已知问题**：
   - 服务化多OCR实例运行时，容易出现文档方向检测模型stdException运行异常（异常发生后会导致假死。内部已实现异常捕获和ocr实例重新初始化）
   - 建议定期监控日志，及时发现和处理异常实例
   - 可以通过健康检查接口监控实例池状态

### 监控和调试

通过健康检查接口可以查看实例池状态：

```bash
curl http://localhost:5000/health
```

返回信息包括：
- 当前可用实例数量
- 实例池总大小
- 服务状态

当所有实例都被占用时，新的请求会收到503错误，提示"OCR服务繁忙，无可用资源"。

## 红色印章识别思路

本系统采用**颜色空间提取 + 区域增强 + OCR识别**的策略来识别红色印章文字：

### 1. HSV颜色空间提取

红色在HSV色相环中位于两端（0-20度和160-180度），系统通过以下步骤提取红色区域：

- **颜色范围定义**：设置两个HSV范围来覆盖所有红色变体（包括偏橙、偏粉的红色）
- **阈值过滤**：通过饱和度和明度的下限（S≥20, V≥20）来识别较浅的红色印章
- **掩码生成**：将符合红色范围的像素标记为红色区域

### 2. 红色区域增强

对于提取出的红色区域，系统会进行多层次的增强处理：

- **饱和度增强**：提升红色饱和度，使浅红色印章更加鲜艳
- **亮度增强**：适当提升红色区域亮度，提高可见性
- **CLAHE局部对比度增强**：使用自适应直方图均衡化，增强文字边缘对比度
- **伽马调整**：通过亮度伽马校正，提亮浅色印章

但如果拍摄图片背景是偏红色时（如将证件放置在红木桌子上手机拍照），受背景色影响导致识别效果较差。

### 3. 干扰去除

在红色区域内，系统会智能去除干扰元素：

- **黑色文字去除**：识别并去除黑色文字和线条（通过亮度阈值判断，但保护暗红色文字）
- **灰色表格线去除**：去除低饱和度的灰色表格线
- **形态学操作**：使用开运算和闭运算去除小噪声点，同时保持文字完整性

### 4. OCR识别
相关技术文档参考[百度飞桨PaddleOCR图片印章检测技术简介](https://github.com/handsomestWei/handsomestWei.github.io/blob/main/_posts/AI/OCR/2025-11-20-%E7%99%BE%E5%BA%A6%E9%A3%9E%E6%A1%A8PaddleOCR%E5%9B%BE%E7%89%87%E5%8D%B0%E7%AB%A0%E6%A3%80%E6%B5%8B%E6%8A%80%E6%9C%AF%E7%AE%80%E4%BB%8B.md)   

对处理后的红色区域图像进行OCR识别，获得最终的文字结果。

## OCR识别完整流程

以下是系统处理一张图片的完整流程：

```
输入图片
    ↓
[图片加载]
    ↓
[图片质量检测]
    ├─→ 文件大小 < 阈值 或 分辨率 < 阈值？
    │       ↓ 是
    │   [图片增强]
    │       ├─→ 去噪处理（非局部均值去噪）
    │       ├─→ 对比度调整
    │       ├─→ 锐化处理（Unsharp Mask）
    │       └─→ 亮度调整
    │       ↓
    └─→ 否 → 跳过增强
    ↓
[预处理开关检查]
    ├─→ 预处理已启用？
    │       ↓ 是
    │   [红色区域提取]
    │       ├─→ BGR转HSV颜色空间
    │       ├─→ HSV范围1匹配（0-20度）
    │       ├─→ HSV范围2匹配（160-180度）
    │       ├─→ 生成红色掩码
    │       ├─→ 轮廓检测与过滤
    │       └─→ 提取红色区域
    │       ↓
    │   [红色区域增强]
    │       ├─→ 饱和度增强
    │       ├─→ 亮度增强
    │       ├─→ CLAHE局部对比度增强
    │       ├─→ 伽马调整
    │       ├─→ 去除黑色文字
    │       └─→ 去除灰色表格线
    │       ↓
    │   处理后的红色区域图像
    │       ↓
    └─→ 否 → 使用原图（或增强后的原图）
    ↓
[图片压缩优化]（可选）
    ├─→ 检查图片尺寸是否超过限制
    ├─→ 超过则按比例缩放
    └─→ JPEG质量压缩
    ↓
[PaddleOCR识别]
    ├─→ 文本检测（检测文字区域）
    ├─→ 文本方向分类（可选，纠正倾斜文字）
    └─→ 文本识别（识别文字内容）
    ↓
[结果后处理]
    ├─→ 提取文字内容
    ├─→ 提取置信度
    ├─→ 提取文字位置坐标
    └─→ 格式化输出
    ↓
识别结果输出
```

### 流程说明

1. **图片加载**：从文件系统或内存加载图片，转换为OpenCV的BGR格式数组

2. **图片质量检测**：根据文件大小和分辨率判断是否为低质量图片
   - 如果文件大小 < 200KB 或 最大边长 < 1200px，判定为低质量图片

3. **图片增强**（仅低质量图片）：
   - 去噪：使用非局部均值去噪，去除JPEG压缩噪声
   - 对比度调整：提升图片整体对比度
   - 锐化：使用Unsharp Mask增强文字边缘
   - 亮度调整：微调图片亮度

4. **预处理开关检查**：根据配置文件决定是否启用红色区域提取

5. **红色区域提取**（如果启用）：
   - 将BGR图像转换为HSV颜色空间
   - 使用两个HSV范围匹配红色像素（覆盖色相环两端的红色）
   - 生成红色掩码
   - 通过轮廓检测和面积过滤，去除噪声和小区域
   - 提取红色区域，非红色区域变为白色

6. **红色区域增强**（如果启用预处理）：
   - 在红色区域内进行多层次增强
   - 去除黑色文字和灰色表格线干扰
   - 使用形态学操作去除小噪声

7. **图片压缩优化**（可选）：
   - 如果图片尺寸超过配置的最大值，按比例缩放
   - 可选的JPEG质量压缩，平衡文件大小和识别质量

8. **PaddleOCR识别**：
   - **文本检测**：使用检测模型定位图片中的文字区域
   - **文本方向分类**（可选）：检测并纠正文字方向（0°、90°、180°、270°）
   - **文本识别**：对每个检测到的文字区域进行识别，输出文字内容和置信度

9. **结果后处理**：整理识别结果，包括文字内容、置信度、位置坐标等信息

## 处理性能
本工程使用cpu推理，默认使用mobile系列的边缘端模型，单张图片识别耗时平均2-4秒，相比于使用server系列服务端模型的平均处理耗时10-20秒有较大的提升。   

注意使用cpu推理时默认会占用全部cpu资源，建议在docker中限制cpu核数，避免影响同服务器的其他服务。

## 项目结构

```
red-seal-ocr/
├── img/                    # 图片文件夹（存放待识别的图片）
├── src/
│   ├── ocr_engine.py      # OCR识别引擎
│   ├── ocr_pool.py        # OCR实例池管理
│   └── preprocess.py      # 图像预处理模块（红色区域提取、图片增强）
├── util/                  # 工具脚本目录
│   ├── check_paddleocr.py      # PaddleOCR安装检测工具
│   ├── debug_image.py          # 单图片调试工具
│   ├── test_seal_recognition.py # 印章识别产线测试工具
│   └── image_downloader.py     # 图片下载工具
├── config.yaml            # 配置文件（YAML格式）
├── main.py                # 主程序入口（命令行模式）
├── api_server.py          # HTTP API服务入口
├── requirements.txt        # 依赖包列表
└── README.md              # 说明文档
```

## 工具脚本说明

### util/check_paddleocr.py

**功能**：检测PaddleOCR安装状态和模型下载情况

**主要功能**：
- 检测PaddleOCR包是否已安装
- 检测PaddlePaddle包是否已安装
- 检测模型文件是否已下载（支持新版本.paddlex目录和旧版本.paddleocr目录）
- 根据配置文件自动识别需要检查的模型（支持从config.yaml读取模型配置）
- 如果模型未下载，可以自动触发下载

**使用方法**：
```bash
# 检测安装状态
python util/check_paddleocr.py

# Docker构建模式（预下载模型）
python util/check_paddleocr.py --docker
```

**输出信息**：
- PaddleOCR和PaddlePaddle的安装状态和版本号
- 已下载的模型列表和路径
- 如果模型未下载，会提示并自动下载

### util/debug_image.py

**功能**：单图片调试工具，用于分析为什么印章没有被识别

**主要功能**：
- 红色区域提取分析：显示HSV范围、红色像素统计、轮廓信息等
- OCR识别调试：显示识别结果、置信度、位置坐标
- 保存调试图像：保存红色区域提取结果、掩码图像等中间结果
- 颜色分析：分析红色区域的颜色分布（BGR和HSV均值、范围）

**使用方法**：
1. 修改脚本中的 `IMAGE_PATH` 变量，指定要调试的图片路径
2. 运行脚本：
```bash
python util/debug_image.py
```

**输出内容**：
- 图片基本信息（尺寸、文件大小）
- HSV颜色范围配置
- 红色像素统计（原始和过滤后）
- 轮廓检测结果（数量、面积、位置、宽高比）
- 红色区域颜色分析（BGR和HSV均值、范围）
- OCR识别结果（文字内容、置信度、位置）
- 调试图像保存到 `debug_output/` 目录

**适用场景**：
- 识别效果不理想时，分析红色区域提取是否正确
- 调整HSV参数时，查看提取效果
- 分析为什么某些文字没有被识别

### util/test_seal_recognition.py

**功能**：测试PaddleOCR的印章识别产线（SealRecognition）

**主要功能**：
- 使用PaddleOCR官方的印章识别产线进行识别
- 支持使用本地印章检测模型
- 显示详细的识别结果，包括布局检测、印章区域、识别文字等

**使用方法**：
```bash
# 使用默认测试图片
python util/test_seal_recognition.py

# 指定图片路径
python util/test_seal_recognition.py <图片路径>

# 指定本地模型目录
python util/test_seal_recognition.py <图片路径> --model-dir <模型目录>
```

**输出信息**：
- 模型设置信息
- 文档方向检测结果
- 布局检测结果（检测到的区域类型和位置）
- 印章识别结果：
  - 检测到的印章区域数量
  - 每个区域的文本检测参数
  - 识别到的文字内容和置信度
  - 文本类型

**注意事项**：
- 使用此工具需要安装PaddleX OCR依赖组：`pip install "paddlex[ocr]"`
- 官方印章识别产线对圆形大印章效果较好，对方形小印章效果可能较差
- 模型会自动从HuggingFace下载，或可通过环境变量设置下载源

**适用场景**：
- 测试官方印章识别产线的效果
- 对比官方产线与自定义红色区域提取方法的识别效果
- 需要识别复杂布局中的印章时

## 配置说明

所有配置项都在 `config.yaml` 文件中，配置文件内已有详细的参数说明。主要配置包括：

- **图像预处理配置**：是否启用红色区域提取
- **红色区域提取配置**：HSV颜色范围、形态学参数
- **红色区域增强配置**：饱和度增强、亮度增强、CLAHE参数等
- **OCR性能优化配置**：模型版本、检测阈值、批处理大小等
- **图片优化配置**：图片压缩、尺寸限制
- **图片增强配置**：低质量图片增强参数
- **HTTP服务器配置**：服务地址、端口、OCR实例池大小等
- **日志配置**：日志级别、文件路径、轮转策略等

## 注意事项

- 首次运行需要下载模型，可能需要一些时间
- 识别准确率受图片质量影响，建议使用清晰、分辨率较高的图片
- 如果印章位置不固定，程序会扫描整张图片进行识别
- 新版本PaddleOCR（3.x）模型存储在 `~/.paddlex/` 目录
- 图像预处理功能默认开启，可根据实际效果决定是否关闭
- 对于浅红色印章，建议启用预处理和红色区域增强功能

## 构建Docker镜像

```bash
# 构建镜像（会在构建时预下载OCR模型）
docker build -t red-seal-ocr:latest .

# 注意：首次构建可能需要较长时间，因为需要下载OCR模型（约几百MB）
```